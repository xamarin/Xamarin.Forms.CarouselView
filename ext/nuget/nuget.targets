<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Import Project="nuget.post.props" />

  <!--NugetRestore-->
  <PropertyGroup>
    <NugetRestoreDependsOn>_NugetRestore</NugetRestoreDependsOn>
  </PropertyGroup>
  <Target
    Name="NugetRestore"
    DependsOnTargets="$(NugetRestoreDependsOn)"
  />
  
  <Target
    Name="_NugetRestore"
    Inputs="@(NugetPackage->'$(NugetPackagesMetaDir)%(Identity)\packages.config')"
    Outputs="$(NugetPackagesMetaDir)%(Identity)\packages.config"
    Condition="'@(NugetPackage)'!=''"
  >
    <!--DownloadNugetExe-->
    <MSBuild
      Projects="$(ProjFile)"
      Targets="Download"
      Properties="SourceUri=$(NugetExeUrl);DestinationFile=$(NugetExe)"
    />
    
    <!--ensure directory for packages.config exists-->
    <ItemGroup>
      <NugetTempConfigFile Include="$(BuildTempConfigDir).config\%(NugetPackage.Identity)\packages.config" />
    </ItemGroup>
    <MakeDir Directories="@(NugetTempConfigFile->'%(RootDir)%(Directory)')" />

    <!--emit packages.config file-->
    <PropertyGroup>
      <NugetPackageAttributes>id='%(NugetPackage.Identity)' version='%(Version)'</NugetPackageAttributes>
      <NugetPackageAttributes Condition="'%(NugetPackage.TargetFramework)'!=''"
        >$(NugetPackageAttributes) targetFramework='%(TargetFramework)'</NugetPackageAttributes>
      <NugetPackageElement>&lt;package $(NugetPackageAttributes)/&gt;</NugetPackageElement>
      <NugetPackageXml>&lt;packages&gt;$(NugetPackageElement)&lt;/packages&gt;</NugetPackageXml>
    </PropertyGroup>
    <WriteLinesToFile
      File="@(NugetTempConfigFile)"
      Lines="$(NugetPackageXml)"
      Overwrite="true"
      Encoding="Unicode"
    />

    <!--execute nuget restore command-->
    <PropertyGroup>
      <NugetRestoreExecVerbosity>quiet</NugetRestoreExecVerbosity>
      <NugetRestoreExecVerbosity Condition="'$(NugetRestoreVerbosity)'=='high'" >normal</NugetRestoreExecVerbosity>

      <NugetRestoreExec>$(NugetExe) restore</NugetRestoreExec>
      <NugetRestoreExec>$(NugetRestoreExec) -OutputDirectory $(NugetPackagesDirAbsolute)</NugetRestoreExec>
      <NugetRestoreExec>$(NugetRestoreExec) -Source $(NugetFeed)</NugetRestoreExec>
      <NugetRestoreExec>$(NugetRestoreExec) -Verbosity $(NugetRestoreExecVerbosity)</NugetRestoreExec>
    </PropertyGroup>
    <Exec Command="$(NugetRestoreExec) @(NugetTempConfigFile)" />

    <!--successfull restore; config file doubles as task input/output-->
    <Message
      Importance="high"
      Text="Download %(NugetPackage.Identity) -> $(NugetPackagesMetaDir)%(Identity)\packages.config"
    />
    <Copy
      SourceFiles="@(NugetTempConfigFile)"
      DestinationFiles="$(NugetPackagesMetaDir)%(NugetPackage.Identity)\packages.config"
    />
  </Target>
</Project>