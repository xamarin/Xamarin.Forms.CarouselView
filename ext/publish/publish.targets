<?xml version="1.0" encoding="utf-8"?>
<Project 
  ToolsVersion="12.0" 
  InitialTargets="_PublishInitialTarget"
  xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <Target Name="Build" DependsOnTargets="Publish" />
  <Target Name="Clean" />
  <Target Name="Rebuild" DependsOnTargets="Clean;Build" />

  <!--_PublishInitialTarget-->
  <Target Name="_PublishInitialTarget" >
    <PropertyGroup>
      <BuildNumberDir>$(BuildByNumberDir)$(BuildNumber)\</BuildNumberDir>
      <BuildRevisionDir>$(BuildByRevisionDir)$(EnlistmentRevision)\</BuildRevisionDir>
      <BuildVersionDir>$(BuildByVersionDir)$(BuildVersion)\</BuildVersionDir>
      <AssemblyVersionDir>$(BuildVersionDir)$(BuildNumber)\</AssemblyVersionDir>
    </PropertyGroup>

    <!--load get status file-->
    <ReadLinesFromFile File="@(EnlistmentStatusFile)">
      <Output TaskParameter="Lines" ItemName="_Lines" />
    </ReadLinesFromFile>
    <PropertyGroup>
      <IsEnlistmentClean Condition="@(_Lines->Count()) == 0">true</IsEnlistmentClean>
    </PropertyGroup>
  </Target>

  <!--Publish-->
  <Target Name="Publish"
    DependsOnTargets="
      _PublishFailIfDirty;
      _PublishByBuildNumber;
      _PublishByRevisionNumber;
      _PublishByVersionNumber;
    "
  />

  <!--_PublishFailIfDirty-->
  <Target Name="_PublishFailIfDirty">
    <Error 
      Condition="'$(IsEnlistmentClean)'!='true'" 
      Text="Publish aborted; Repository dirty at time of build. Set IsEnlistmentClean=true to override. See: @(EnlistmentStatusFile)" 
    />
  </Target>

  <!--_PublishByBuildNumber-->
  <Target 
    Name="_PublishByBuildNumber"
    DependsOnTargets="_PublishFailIfDirty"
  >  
    <Error
      Condition="Exists($(BuildNumberDir))"
      Text="Publication directory '$(BuildNumberDir)' already exists."
    />
    
    <!--copy build-->
    <Message Importance="high" Text="$(BuildBinDir) -> $(BuildNumberDir)" />
    <ItemGroup>
      <_BuildFiles Include="$(BuildBinDir)**" />
    </ItemGroup>
    <MakeDir Directories="$(BuildNumberDir)" />
    <Copy SourceFiles="@(_BuildFiles)" DestinationFolder="$(BuildNumberDir)%(RecursiveDir)" />
  </Target>

  <!--_PublishByRevisionNumber-->
  <Target
    Name="_PublishByRevisionNumber"
    DependsOnTargets="_PublishByBuildNumber"
    Condition="'$(IsEnlistmentClean)'=='true'"
  >
    <MakeDir Directories="$(BuildByRevisionDir)" />
   
    <Error
      Condition="Exists($(BuildRevisionDir))"
      Text="Publication directory '$(BuildRevisionDir)' already exists."
    />

    <Message Importance="high" Text="$(BuildRevisionDir) -> $(BuildNumberDir)" />
    <Exec Command="mklink /J $(BuildRevisionDir) $(BuildNumberDir) >NUL" />
  </Target>

  <!--_PublishByVersionNumber-->
  <Target
    Name="_PublishByVersionNumber"
    DependsOnTargets="_PublishByBuildNumber"
    Condition="'$(IsEnlistmentClean)'=='true' AND '$(BuildVersion)'!=''"
  >
    <MakeDir Directories="$(BuildByVersionDir)" />
    <MakeDir Directories="$(BuildVersionDir)" />

    <Error
      Condition="Exists($(AssemblyVersionDir))"
      Text="Publication directory '$(AssemblyVersionDir)' already exists."
    />

    <Message Importance="high" Text="$(AssemblyVersionDir) -> $(BuildNumberDir)" />
    <Exec Command="mklink /J $(AssemblyVersionDir) $(BuildNumberDir) >NUL" />
  </Target>
</Project>