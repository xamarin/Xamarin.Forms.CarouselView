<?xml version="1.0" encoding="utf-8"?>
<Project 
  ToolsVersion="12.0" 
  DefaultTargets="Build" 
  xmlns="http://schemas.microsoft.com/developer/msbuild/2003"
>
  
  <!--
    
    DryRun
  -->
  <PropertyGroup>
    <DryRunDependsOn />
  </PropertyGroup>
  <Target
    Name="DryRun"
    DependsOnTargets="$(DryRunDependsOn)"
    Returns="@(TargetResult)"
  >
    <ItemGroup>
      <TargetResult Include="(path to $(ProjName) result [$(FrameId)])" />
    </ItemGroup>
  </Target>

  <!--ResolveMetaReferences-->
  <PropertyGroup>
    <ResolveMetaReferencesDependsOn>
      _DumpFrame;
      _ResolveMetaReferences;
    </ResolveMetaReferencesDependsOn>
  </PropertyGroup>
  <Target
    Name="ResolveMetaReferences"
    BeforeTargets="Proxy"
    DependsOnTargets="$(ResolveMetaReferencesDependsOn)"
  />

  <!--_ResolveMetaReferences-->
  <Target
    Name="_ResolveMetaReferences"
    Outputs="%(Configuration.Identity)"
  >
    <PropertyGroup>
      <MetaBuildTarget Condition="'$(MetaBuildTarget)'==''">$(BuildTarget)</MetaBuildTarget>
    </PropertyGroup>
    
    <!--input MetaReferences-->
    <Message
      Text="$(ProjName) [$(FrameId)] references:"
      Condition="@(MetaReference->Count()) > 0"
      Importance="$(Verbosity)"
    />
    <Message
      Text="  %(MetaReference.ReferenceSource): %(Identity) /t:$(MetaBuildTarget) /+p:%(AdditionalProperties)"
      Condition="@(MetaReference->Count()) > 0"
      Importance="$(Verbosity)"
    />

    <!--build MetaReferences-->
    <MSBuild
      Projects="@(MetaReference)"
      Targets="$(MetaBuildTarget)"
      Properties="Configuration=%(Configuration.Identity)"
      BuildInParallel="true"
      RemoveProperties="$(FrameProperties)"
    >
      <Output ItemName="TargetResult" TaskParameter="TargetOutputs" />
    </MSBuild>

    <!--refresh MetaReferences-->
    <ItemGroup>
      <MetaReference Remove="@(MetaReference)"/>
      <MetaReference Include="@(TargetResult)"/>
    </ItemGroup>

    <!--output MetaReferences-->
    <Message
      Text="$(ProjName) [$(FrameId)] resolutions:"
      Condition="@(MetaReference->Count()) > 0"
      Importance="$(Verbosity)"
    />
    <Message
      Text="  %(ReferenceSource): %(MetaReference.Identity)"
      Condition="@(MetaReference->Count()) > 0"
      Importance="$(Verbosity)"
    />
  </Target>

  <!--_AugmentReferences-->
  <Target
    Name="_AugmentReferences"
    AfterTargets="ResolveMetaReferences"
  >
    <!--MetaReference -> Reference-->
    <ItemGroup>
      <_Reference Include="@(MetaReference->WithMetadataValue('IncludeInReferences', 'true'))" />
      <Reference Include="@(_Reference->'%(Name)')" >
        <HintPath>%(Identity)</HintPath>
      </Reference>
    </ItemGroup>
    <Message 
      Text="$(ProjName) [$(FrameId)]: Reference += %(Identity)"
      Condition="@(_Reference->Count()) > 0"
      Importance="$(Verbosity)" 
    />
  </Target>

  <!--_TrimTargetResult-->
  <Target
    Name="_TrimTargetResult"
    AfterTargets="ResolveMetaReferences"
  >
    <ItemGroup>
      <TargetResult Remove="@(MetaReference->WithMetadataValue('ExcludeFromTargetResult', 'true'))" />
    </ItemGroup>
  </Target>

  <!--
  
    _DumpFrame
  -->
  <Target
    Name="_DumpFrame"
    Condition="'$(BuildTarget)'=='DryRun' OR '$(Verbosity)'=='high'"
  >
    <PropertyGroup>
      <Tag>BUILD</Tag>
      <Tag Condition="'$(IsPrimitivePlatform)'!='true'">RECURSE</Tag>
    </PropertyGroup>

    <ItemGroup>
      <_Property Include="BuildTarget" />
      <_Property Include="ProjFile" />
      <_Property Include="IsPrimitivePlatform" />
      <_Property Include="IsProxyPlatform" />
      <_Property Include="IsMobileLibraryPlatform" />
      <_Property Include="IsMobileAppPlatform" />
      <_Property Include="IsPartPlatform" />
      <_Property Include="IsMobileAppProject" />
      <_Property Include="IsMobileLibraryProject" />
      <_Property Include="IsMobileTestProject" />
      <_Property Include="IsDesktopLibraryProject" />
      <_Property Include="PrimitivePlatform" />
      <_Property Include="MobilePlatform" />
      <_Property Include="MobileSubPlatform" />
      <_Property Include="LibraryPlatform" />
      <_Property Include="DefineConstants" />
      <_Property Include="TargetProject" />
      <_Property Include="CommonTargetsPath" />
      <_Property Include="BuildingInsideVisualStudio" />
      <_Property Include="FrameProperties" />
    </ItemGroup>
    <ItemGroup Condition="'$(IsPrimitivePlatform)'=='true'">
      <_Property Include="OutDirAbsolute" />
      <_Property Include="IntermediateOutputPathAbsolute" />
      <_Property Include="TargetsFile" />
    </ItemGroup>

    <Message 
      Importance="high" 
      Text="$(Tag) [$(FrameId)]: $(AssemblyName) -> { @(MetaReference->'%(Platform)', ', ') }"
    />
    <Message
      Importance="high"
      Text="  %(_Property.Identity) -> $(%(Identity))"
      Condition="'$(%(Identity))'!='' AND '$(%(Identity))'!='false'"
    />
    <Message
      Importance="high"
      Text="    ProjectReference: %(ProjectReference.Identity) -> %(FullPath)"
      Condition="'@(ProjectReference)'!=''"
    />
  </Target>
  
</Project>